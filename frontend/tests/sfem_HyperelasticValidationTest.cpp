/**
 * @file sfem_HyperelasticValidationTest.cpp
 * @brief Validation test for pure hyperelastic Mooney-Rivlin against Marc
 * 
 * Test: Uniaxial tension on 1x1x1 mm hex8 element
 * Input: Displacement X from Marc (Column E)
 * Output: Reaction Force X Node 7 (Column G)
 * 
 * Material: EPDM rubber (C10=0.499 MPa, C01=0.577 MPa)
 */

#include <cmath>
#include <cstdio>
#include <cstring>
#include <vector>

#include "sfem_base.h"

extern "C" {
#include "hex8_mooney_rivlin_visco_flexible.h"
}

// ========== Hyperelastic Validation Data (335 points from Marc) ==========
static const int num_hyperelastic_points = 335;

static const double hyperelastic_times[] = {
    0.000000, 1.000000, 2.000000, 3.000000, 4.000000, 5.000000, 6.000000, 7.000000, 8.000000, 9.000000,
    10.000000, 11.000000, 12.000000, 13.000000, 14.000000, 15.000000, 16.000000, 17.000000, 18.000000, 19.000000,
    20.000000, 21.000000, 22.000000, 23.000000, 24.000000, 25.000000, 26.000000, 27.000000, 28.000000, 29.000000,
    30.000000, 31.000000, 32.000000, 33.000000, 34.000000, 35.000000, 36.000000, 37.000000, 38.000000, 39.000000,
    40.000000, 41.000000, 42.000000, 43.000000, 44.000000, 45.000000, 46.000000, 47.000000, 48.000000, 49.000000,
    50.000000, 51.000000, 52.000000, 53.000000, 54.000000, 55.000000, 56.000000, 57.000000, 58.000000, 59.000000,
    60.000000, 61.000000, 62.000000, 63.000000, 64.000000, 65.000000, 66.000000, 67.000000, 68.000000, 69.000000,
    70.000000, 71.000000, 72.000000, 73.000000, 74.000000, 75.000000, 76.000000, 77.000000, 78.000000, 79.000000,
    80.000000, 81.000000, 82.000000, 83.000000, 84.000000, 85.000000, 86.000000, 87.000000, 88.000000, 89.000000,
    90.000000, 91.000000, 92.000000, 93.000000, 94.000000, 95.000000, 96.000000, 97.000000, 98.000000, 99.000000,
    100.000000, 101.000000, 102.000000, 103.000000, 104.000000, 105.000000, 106.000000, 107.000000, 108.000000, 109.000000,
    110.000000, 111.000000, 112.000000, 113.000000, 114.000000, 115.000000, 116.000000, 117.000000, 118.000000, 119.000000,
    120.000000, 121.000000, 122.000000, 123.000000, 124.000000, 125.000000, 126.000000, 127.000000, 128.000000, 129.000000,
    130.000000, 131.000000, 132.000000, 133.000000, 134.000000, 135.000000, 136.000000, 137.000000, 138.000000, 139.000000,
    140.000000, 141.000000, 142.000000, 143.000000, 144.000000, 145.000000, 146.000000, 147.000000, 148.000000, 149.000000,
    150.000000, 151.000000, 152.000000, 153.000000, 154.000000, 155.000000, 156.000000, 157.000000, 158.000000, 159.000000,
    160.000000, 161.000000, 162.000000, 163.000000, 164.000000, 165.000000, 166.000000, 167.000000, 168.000000, 169.000000,
    170.000000, 171.000000, 172.000000, 173.000000, 174.000000, 175.000000, 176.000000, 177.000000, 178.000000, 179.000000,
    180.000000, 181.000000, 182.000000, 183.000000, 184.000000, 185.000000, 186.000000, 187.000000, 188.000000, 189.000000,
    190.000000, 191.000000, 192.000000, 193.000000, 194.000000, 195.000000, 196.000000, 197.000000, 198.000000, 199.000000,
    200.000000, 201.000000, 202.000000, 203.000000, 204.000000, 205.000000, 206.000000, 207.000000, 208.000000, 209.000000,
    210.000000, 211.000000, 212.000000, 213.000000, 214.000000, 215.000000, 216.000000, 217.000000, 218.000000, 219.000000,
    220.000000, 221.000000, 222.000000, 223.000000, 224.000000, 225.000000, 226.000000, 227.000000, 228.000000, 229.000000,
    230.000000, 231.000000, 232.000000, 233.000000, 234.000000, 235.000000, 236.000000, 237.000000, 238.000000, 239.000000,
    240.000000, 241.000000, 242.000000, 243.000000, 244.000000, 245.000000, 246.000000, 247.000000, 248.000000, 249.000000,
    250.000000, 251.000000, 252.000000, 253.000000, 254.000000, 255.000000, 256.000000, 257.000000, 258.000000, 259.000000,
    260.000000, 261.000000, 262.000000, 263.000000, 264.000000, 265.000000, 266.000000, 267.000000, 268.000000, 269.000000,
    270.000000, 271.000000, 272.000000, 273.000000, 274.000000, 275.000000, 276.000000, 277.000000, 278.000000, 279.000000,
    280.000000, 281.000000, 282.000000, 283.000000, 284.000000, 285.000000, 286.000000, 287.000000, 288.000000, 289.000000,
    290.000000, 291.000000, 292.000000, 293.000000, 294.000000, 295.000000, 296.000000, 297.000000, 298.000000, 299.000000,
    300.000000, 301.000000, 302.000000, 303.000000, 304.000000, 305.000000, 306.000000, 307.000000, 308.000000, 309.000000,
    310.000000, 311.000000, 312.000000, 313.000000, 314.000000, 315.000000, 316.000000, 317.000000, 318.000000, 319.000000,
    320.000000, 321.000000, 322.000000, 323.000000, 324.000000, 325.000000, 326.000000, 327.000000, 328.000000, 329.000000,
    330.000000, 331.000000, 332.000000, 333.000000, 334.000000
};

// Displacement X of Node 7 [mm]
static const double hyperelastic_disp[] = {
    0.0000000000e+00, 1.3681087876e-03, 4.4283149764e-03, 8.9843673632e-03, 1.3542267494e-02,
    1.8061580136e-02, 2.2575667128e-02, 2.7090281248e-02, 3.1638354063e-02, 3.6349870265e-02,
    4.0931232274e-02, 4.5515425503e-02, 5.0114993006e-02, 5.4703939706e-02, 5.9352304786e-02,
    6.3990943134e-02, 6.8598888814e-02, 7.3185965419e-02, 7.7762037516e-02, 8.2371599972e-02,
    8.7067522109e-02, 9.1666206717e-02, 9.6236534417e-02, 1.0079280287e-01, 1.0539462417e-01,
    1.1002891511e-01, 1.1478069425e-01, 1.1948988587e-01, 1.2413156033e-01, 1.2874747813e-01,
    1.3338644803e-01, 1.3810780644e-01, 1.4278614521e-01, 1.4743526280e-01, 1.5212766826e-01,
    1.5684086084e-01, 1.6163288057e-01, 1.6637092829e-01, 1.7102859914e-01, 1.7573662102e-01,
    1.8047276139e-01, 1.8528552353e-01, 1.9010429084e-01, 1.9487653673e-01, 1.9962143898e-01,
    2.0432786644e-01, 2.0905901492e-01, 2.1380670369e-01, 2.1855457127e-01, 2.2329939902e-01,
    2.2796173394e-01, 2.3262326419e-01, 2.3728291690e-01, 2.4195536971e-01, 2.4663975835e-01,
    2.5126007199e-01, 2.5585284829e-01, 2.6044940948e-01, 2.6504409313e-01, 2.6962497830e-01,
    2.7415287495e-01, 2.7851614356e-01, 2.8289347887e-01, 2.8728967905e-01, 2.9181814194e-01,
    2.9640221596e-01, 3.0080467463e-01, 3.0518335104e-01, 3.0950692296e-01, 3.1388670206e-01,
    3.1835234165e-01, 3.2272288203e-01, 3.2701790333e-01, 3.3123281598e-01, 3.3536458015e-01,
    3.3948206902e-01, 3.4358745813e-01, 3.4451439977e-01, 3.4491083026e-01, 3.4530729055e-01,
    3.4570372105e-01, 3.4610015154e-01, 3.4649661183e-01, 3.4654355049e-01, 3.4654808044e-01,
    3.4655258060e-01, 3.4655711055e-01, 3.4656164050e-01, 3.4656617045e-01, 3.4657070041e-01,
    3.4657520056e-01, 3.4657973051e-01, 3.4658426046e-01, 3.4658879042e-01, 3.4659332037e-01,
    3.4659785032e-01, 3.4660235047e-01, 3.4660688043e-01, 3.4661141038e-01, 3.4661594033e-01,
    3.4662047029e-01, 3.4662497044e-01, 3.4662950039e-01, 3.4663403034e-01, 3.4663856030e-01,
    3.4664309025e-01, 3.4664759040e-01, 3.4665212035e-01, 3.4665665030e-01, 3.4666118026e-01,
    3.4666571021e-01, 3.4667024016e-01, 3.4667474031e-01, 3.4667927027e-01, 3.4668216109e-01,
    3.4668302536e-01, 3.4668388963e-01, 3.4668478370e-01, 3.4668564796e-01, 3.4668651223e-01,
    3.4668737650e-01, 3.4668824077e-01, 3.4668910503e-01, 3.4668996930e-01, 3.4669083357e-01,
    3.4669172764e-01, 3.4669259191e-01, 3.4669345617e-01, 3.4669432044e-01, 3.4669518471e-01,
    3.4669604897e-01, 3.4669691324e-01, 3.4669777751e-01, 3.4669867158e-01, 3.4669953585e-01,
    3.4670040011e-01, 3.4670126438e-01, 3.4670212865e-01, 3.4670299292e-01, 3.4670385718e-01,
    3.4670472145e-01, 3.4670561552e-01, 3.4670647979e-01, 3.4670734406e-01, 3.4670820832e-01,
    3.4670907259e-01, 3.4670993686e-01, 3.4671080112e-01, 3.4671166539e-01, 3.4671252966e-01,
    3.4671342373e-01, 3.4671428800e-01, 3.4671515226e-01, 3.4671601653e-01, 3.4671688080e-01,
    3.4671774507e-01, 3.4671860933e-01, 3.4671947360e-01, 3.4672036767e-01, 3.4672123194e-01,
    3.4672209620e-01, 3.4672296047e-01, 3.4672382474e-01, 3.4672468901e-01, 3.4672555327e-01,
    3.4672641754e-01, 3.4672731161e-01, 3.4672817588e-01, 3.4672904015e-01, 3.4672990441e-01,
    3.4673076868e-01, 3.4673163295e-01, 3.4673249722e-01, 3.4673336148e-01, 3.4673425555e-01,
    3.4673511982e-01, 3.4673598409e-01, 3.4673684835e-01, 3.4673771262e-01, 3.4673857689e-01,
    3.4673944116e-01, 3.4674030542e-01, 3.4674119949e-01, 3.4674206376e-01, 3.4674292803e-01,
    3.4674379230e-01, 3.4674465656e-01, 3.4674552083e-01, 3.4674638510e-01, 3.4674724936e-01,
    3.4674814343e-01, 3.4674900770e-01, 3.4674987197e-01, 3.4675073624e-01, 3.4675160050e-01,
    3.4675246477e-01, 3.4675332904e-01, 3.4675419331e-01, 3.4675505757e-01, 3.4675595164e-01,
    3.4675681591e-01, 3.4675768018e-01, 3.4675854445e-01, 3.4675940871e-01, 3.4676027298e-01,
    3.4676113725e-01, 3.4676200151e-01, 3.4676289558e-01, 3.4676375985e-01, 3.4676462412e-01,
    3.4676548839e-01, 3.4676635265e-01, 3.4676721692e-01, 3.4676808119e-01, 3.4676894546e-01,
    3.4676983953e-01, 3.4677070379e-01, 3.4677156806e-01, 3.4677243233e-01, 3.4677329659e-01,
    3.4677416086e-01, 3.4677502513e-01, 3.4677588940e-01, 3.4677678347e-01, 3.4677764773e-01,
    3.4677851200e-01, 3.4677937627e-01, 3.4678024054e-01, 3.4678110480e-01, 3.4678196907e-01,
    3.4678283334e-01, 3.4678372741e-01, 3.4678459167e-01, 3.4678545594e-01, 3.4678632021e-01,
    3.4678718448e-01, 3.4678804874e-01, 3.4678891301e-01, 3.4678977728e-01, 3.4679067135e-01,
    3.4679153562e-01, 3.4679239988e-01, 3.4671697021e-01, 3.4656757116e-01, 3.4641817212e-01,
    3.4626877308e-01, 3.4611934423e-01, 3.4596994519e-01, 3.4582054615e-01, 3.4567114711e-01,
    3.4552174807e-01, 3.4537234902e-01, 3.4522294998e-01, 3.4507355094e-01, 3.4492412210e-01,
    3.4477472305e-01, 3.4462532401e-01, 3.4447592497e-01, 3.4432652593e-01, 3.4417712688e-01,
    3.4331524372e-01, 3.3916142583e-01, 3.3498704433e-01, 3.3079126477e-01, 3.2653537393e-01,
    3.2220858335e-01, 3.1780180335e-01, 3.1336608529e-01, 3.0887356400e-01, 3.0432692170e-01,
    2.9983252287e-01, 2.9532292485e-01, 2.9076394439e-01, 2.8617542982e-01, 2.8157928586e-01,
    2.7716109157e-01, 2.7271226048e-01, 2.6820266247e-01, 2.6359859109e-01, 2.5894621015e-01,
    2.5417000055e-01, 2.4944341183e-01, 2.4483479559e-01, 2.4018067122e-01, 2.3548930883e-01,
    2.3077100515e-01, 2.2605250776e-01, 2.2142834961e-01, 2.1679079533e-01, 2.1211901307e-01,
    2.0737947524e-01, 2.0259307325e-01, 1.9782091677e-01, 1.9304966927e-01, 1.8826828897e-01,
    1.8348152936e-01, 1.7868624628e-01, 1.7397645116e-01, 1.6929638386e-01, 1.6451983154e-01,
    1.5973539650e-01, 1.5492509305e-01, 1.5019127727e-01, 1.4551973343e-01, 1.4088685811e-01,
    1.3625995815e-01, 1.3161659241e-01, 1.2694336474e-01, 1.2221744657e-01, 1.1755604297e-01,
    1.1294741184e-01, 1.0832703859e-01, 1.0369525850e-01, 9.8987720907e-02, 9.4349712133e-02,
    8.9782916009e-02, 8.5230290890e-02, 8.0662757158e-02, 7.6007723808e-02, 7.1378573775e-02,
    6.6769599915e-02, 6.2173031271e-02, 5.7570632547e-02, 5.2938811481e-02, 4.8330377787e-02,
    4.3739296496e-02, 3.9159726352e-02, 3.4593574703e-02, 3.0040068552e-02, 2.5493659079e-02,
    2.0990259945e-02, 1.6539845616e-02, 1.2076252140e-02, 7.6974844560e-03, 3.3987599891e-03
};

// Reaction Force X of Node 7 [N] from Marc
static const double hyperelastic_rf[] = {
    0.0000000000e+00, 2.2052393761e-03, 7.1064312942e-03, 1.4319203794e-02, 2.1429821849e-02,
    2.8384543955e-02, 3.5238415003e-02, 4.2002089322e-02, 4.8725880682e-02, 5.5598426610e-02,
    6.2190525234e-02, 6.8700976670e-02, 7.5148306787e-02, 8.1497520208e-02, 8.7846294045e-02,
    9.4099998474e-02, 1.0023324192e-01, 1.0626213253e-01, 1.1220193654e-01, 1.1811146885e-01,
    1.2405715138e-01, 1.2980739772e-01, 1.3545353711e-01, 1.4101532102e-01, 1.4656630158e-01,
    1.5209001303e-01, 1.5768624842e-01, 1.6316540539e-01, 1.6850249469e-01, 1.7374885082e-01,
    1.7896118760e-01, 1.8420530856e-01, 1.8934178352e-01, 1.9438867271e-01, 1.9942566752e-01,
    2.0442825556e-01, 2.0945757627e-01, 2.1437434852e-01, 2.1915486455e-01, 2.2393517196e-01,
    2.2869198024e-01, 2.3347340524e-01, 2.3820869625e-01, 2.4284787476e-01, 2.4741181731e-01,
    2.5189167261e-01, 2.5634875894e-01, 2.6077550650e-01, 2.6515719295e-01, 2.6949176192e-01,
    2.7370843291e-01, 2.7788326144e-01, 2.8201588988e-01, 2.8611993790e-01, 2.9019498825e-01,
    2.9417613149e-01, 2.9809677601e-01, 3.0198457837e-01, 3.0583530664e-01, 3.0963969231e-01,
    3.1336644292e-01, 3.1692650914e-01, 3.2046824694e-01, 3.2399535179e-01, 3.2759791613e-01,
    3.3121329546e-01, 3.3465588093e-01, 3.3805218339e-01, 3.4137877822e-01, 3.4472194314e-01,
    3.4810328484e-01, 3.5138601065e-01, 3.5458704829e-01, 3.5770457983e-01, 3.6073812842e-01,
    3.6373943090e-01, 3.6671051383e-01, 3.6737620831e-01, 3.6766144633e-01, 3.6794659495e-01,
    3.6823153496e-01, 3.6851626635e-01, 3.6880081892e-01, 3.6883449554e-01, 3.6883774400e-01,
    3.6884099245e-01, 3.6884421110e-01, 3.6884745955e-01, 3.6885070801e-01, 3.6885395646e-01,
    3.6885720491e-01, 3.6886045337e-01, 3.6886370182e-01, 3.6886695027e-01, 3.6887019873e-01,
    3.6887344718e-01, 3.6887669563e-01, 3.6887991428e-01, 3.6888316274e-01, 3.6888641119e-01,
    3.6888965964e-01, 3.6889290810e-01, 3.6889615655e-01, 3.6889940500e-01, 3.6890265346e-01,
    3.6890590191e-01, 3.6890915036e-01, 3.6891236901e-01, 3.6891561747e-01, 3.6891886592e-01,
    3.6892211437e-01, 3.6892536283e-01, 3.6892861128e-01, 3.6893185973e-01, 3.6893391609e-01,
    3.6893454194e-01, 3.6893516779e-01, 3.6893579364e-01, 3.6893641949e-01, 3.6893704534e-01,
    3.6893767118e-01, 3.6893829703e-01, 3.6893892288e-01, 3.6893951893e-01, 3.6894014478e-01,
    3.6894077063e-01, 3.6894139647e-01, 3.6894202232e-01, 3.6894264817e-01, 3.6894327402e-01,
    3.6894389987e-01, 3.6894452572e-01, 3.6894512177e-01, 3.6894574761e-01, 3.6894637346e-01,
    3.6894699931e-01, 3.6894762516e-01, 3.6894825101e-01, 3.6894887686e-01, 3.6894950271e-01,
    3.6895012856e-01, 3.6895072460e-01, 3.6895135045e-01, 3.6895197630e-01, 3.6895260215e-01,
    3.6895322800e-01, 3.6895385385e-01, 3.6895447969e-01, 3.6895510554e-01, 3.6895573139e-01,
    3.6895632744e-01, 3.6895695329e-01, 3.6895757914e-01, 3.6895820498e-01, 3.6895883083e-01,
    3.6895945668e-01, 3.6896008253e-01, 3.6896070838e-01, 3.6896133423e-01, 3.6896193027e-01,
    3.6896255612e-01, 3.6896318197e-01, 3.6896380782e-01, 3.6896443367e-01, 3.6896505952e-01,
    3.6896568537e-01, 3.6896631122e-01, 3.6896693707e-01, 3.6896753311e-01, 3.6896815896e-01,
    3.6896878481e-01, 3.6896941066e-01, 3.6897003651e-01, 3.6897066236e-01, 3.6897128820e-01,
    3.6897191405e-01, 3.6897253990e-01, 3.6897313595e-01, 3.6897376180e-01, 3.6897438765e-01,
    3.6897501349e-01, 3.6897563934e-01, 3.6897626519e-01, 3.6897689104e-01, 3.6897751689e-01,
    3.6897814274e-01, 3.6897873878e-01, 3.6897936463e-01, 3.6897999048e-01, 3.6898061633e-01,
    3.6898124218e-01, 3.6898186803e-01, 3.6898249388e-01, 3.6898311973e-01, 3.6898371577e-01,
    3.6898434162e-01, 3.6898496747e-01, 3.6898559332e-01, 3.6898621917e-01, 3.6898684502e-01,
    3.6898747087e-01, 3.6898809671e-01, 3.6898872256e-01, 3.6898931861e-01, 3.6898994446e-01,
    3.6899057031e-01, 3.6899119616e-01, 3.6899182200e-01, 3.6899244785e-01, 3.6899307370e-01,
    3.6899369955e-01, 3.6899432540e-01, 3.6899492145e-01, 3.6899554729e-01, 3.6899617314e-01,
    3.6899679899e-01, 3.6899742484e-01, 3.6899805069e-01, 3.6899867654e-01, 3.6899930239e-01,
    3.6899992824e-01, 3.6900052428e-01, 3.6900115013e-01, 3.6900177598e-01, 3.6900240183e-01,
    3.6900302768e-01, 3.6900365353e-01, 3.6900427938e-01, 3.6900490522e-01, 3.6900553107e-01,
    3.6900612712e-01, 3.6900675297e-01, 3.6900737882e-01, 3.6900800467e-01, 3.6900863051e-01,
    3.6900925636e-01, 3.6900988221e-01, 3.6901050806e-01, 3.6901110411e-01, 3.6901172996e-01,
    3.6901235580e-01, 3.6901298165e-01, 3.6895889044e-01, 3.6885172129e-01, 3.6874452233e-01,
    3.6863729358e-01, 3.6853003502e-01, 3.6842274666e-01, 3.6831545830e-01, 3.6820811033e-01,
    3.6810073256e-01, 3.6799335480e-01, 3.6788591743e-01, 3.6777848005e-01, 3.6767101288e-01,
    3.6756348610e-01, 3.6745595932e-01, 3.6734840274e-01, 3.6724081635e-01, 3.6713320017e-01,
    3.6651194096e-01, 3.6350646615e-01, 3.6046186090e-01, 3.5737898946e-01, 3.5422852635e-01,
    3.5100093484e-01, 3.4768778086e-01, 3.4432595968e-01, 3.4089329839e-01, 3.3739021420e-01,
    3.3389812708e-01, 3.3036470413e-01, 3.2676205039e-01, 3.2310441136e-01, 3.1940832734e-01,
    3.1582406163e-01, 3.1218409538e-01, 3.0846193433e-01, 3.0462756753e-01, 3.0071711540e-01,
    2.9666462541e-01, 2.9261529446e-01, 2.8862923384e-01, 2.8456568718e-01, 2.8042984009e-01,
    2.7622929215e-01, 2.7198666334e-01, 2.6778739691e-01, 2.6353433728e-01, 2.5920686126e-01,
    2.5477170944e-01, 2.5024580956e-01, 2.4568553269e-01, 2.4107763171e-01, 2.3641036451e-01,
    2.3168715835e-01, 2.2690375149e-01, 2.2215399146e-01, 2.1738286316e-01, 2.1245983243e-01,
    2.0747284591e-01, 2.0240177214e-01, 1.9735397398e-01, 1.9231601059e-01, 1.8726326525e-01,
    1.8215979636e-01, 1.7697955668e-01, 1.7170552909e-01, 1.6630917788e-01, 1.6092292964e-01,
    1.5553474426e-01, 1.5006899834e-01, 1.4452414215e-01, 1.3882011175e-01, 1.3313081861e-01,
    1.2746056914e-01, 1.2173929811e-01, 1.1592898518e-01, 1.0993362963e-01, 1.0389561206e-01,
    9.7807519138e-02, 9.1658353806e-02, 8.5422344506e-02, 7.9064987600e-02, 7.2656631470e-02,
    6.6188491881e-02, 5.9651393443e-02, 5.3046975285e-02, 4.6373061836e-02, 3.9620287716e-02,
    3.2841436565e-02, 2.6052661240e-02, 1.9152723253e-02, 1.2292711996e-02, 5.4688868113e-03
};

// EPDM material parameters
// Marc hyperelastic uses FITTING parameters (verified by stress calculation)
static const double EPDM_C10 = 0.499;    // MPa
static const double EPDM_C01 = 0.577;    // MPa
static const double EPDM_K = 10000.0;    // MPa (bulk modulus)

int main(int argc, char* argv[]) {
    printf("=======================================================\n");
    printf("Hyperelastic Mooney-Rivlin Validation Test\n");
    printf("=======================================================\n");
    printf("Material: EPDM rubber\n");
    printf("C10 = %.6f MPa, C01 = %.6f MPa, K = %.1f MPa\n", EPDM_C10, EPDM_C01, EPDM_K);
    printf("Element: 1x1x1 mm Hex8\n");
    printf("Test points: %d\n", num_hyperelastic_points);
    printf("=======================================================\n\n");
    
    // Mesh: 1x1x1 mm single hex8 element (8 nodes)
    geom_t x_arr[8] = {0, 1, 1, 0, 0, 1, 1, 0};
    geom_t y_arr[8] = {0, 0, 1, 1, 0, 0, 1, 1};
    geom_t z_arr[8] = {0, 0, 0, 0, 1, 1, 1, 1};
    geom_t* points[3] = {x_arr, y_arr, z_arr};
    
    idx_t elem0[8] = {0, 1, 2, 3, 4, 5, 6, 7};
    idx_t* elements[8];
    for (int i = 0; i < 8; ++i) elements[i] = &elem0[i];
    
    // Displacement and gradient arrays
    real_t dispx[8] = {0}, dispy[8] = {0}, dispz[8] = {0};
    real_t gx[8], gy[8], gz[8];
    
    // Pure hyperelastic: num_prony_terms=0, history=NULL
    const int num_prony_terms = 0;
    const real_t dt = 1.0;
    const real_t* g = nullptr;
    const real_t* tau = nullptr;
    const real_t* history = nullptr;
    
    // Results storage
    double max_error = 0.0;
    double sum_error = 0.0;
    int count = 0;
    
    printf("%6s  %12s  %12s  %12s  %12s  %8s\n",
           "Time", "Disp[mm]", "Marc_RF[N]", "SFEM_RF[N]", "Error[N]", "Error%");
    printf("----------------------------------------------------------------------\n");
    
    // Test each data point
    for (int i = 0; i < num_hyperelastic_points; ++i) {
        double t = hyperelastic_times[i];
        double disp = hyperelastic_disp[i];
        double marc_rf = hyperelastic_rf[i];
        
        // Skip zero displacement
        if (fabs(disp) < 1e-12) {
            if (i % 20 == 0) {
                printf("%6.1f  %12.6e  %12.6e  %12.6e  %12.6e  %8.2f%%\n",
                       t, disp, marc_rf, 0.0, 0.0, 0.0);
            }
            continue;
        }
        
        // Marc boundary conditions (from screenshot):
        // - Fix X: origin only (node 0)  
        // - Fix Y: bottom face (y=0)
        // - Fix Z: back face (z=0)
        // - Displacement X: right face (x=1)
        //
        // For incompressible material in uniaxial test:
        // F = diag(λ, λ_lat, λ_lat) where λ*λ_lat² = 1
        double lam = 1.0 + disp;
        double lam_lat = 1.0 / sqrt(lam);
        
        // Node coordinates after deformation:
        // Original: (x, y, z) -> Deformed: (x*lam_x, y*lam_lat, z*lam_lat)
        // Displacement = deformed - original
        //
        // Node 0: (0,0,0) -> disp = (0, 0, 0)
        // Node 1: (1,0,0) -> disp = (lam-1, 0, 0) = (disp, 0, 0)
        // Node 2: (1,1,0) -> disp = (lam-1, lam_lat-1, 0)
        // Node 3: (0,1,0) -> disp = (0, lam_lat-1, 0)
        // Node 4: (0,0,1) -> disp = (0, 0, lam_lat-1)
        // Node 5: (1,0,1) -> disp = (lam-1, 0, lam_lat-1)
        // Node 6: (1,1,1) -> disp = (lam-1, lam_lat-1, lam_lat-1)
        // Node 7: (0,1,1) -> disp = (0, lam_lat-1, lam_lat-1)
        
        double lat_d = lam_lat - 1.0;
        
        dispx[0] = 0.0;   dispx[1] = disp;  dispx[2] = disp;  dispx[3] = 0.0;
        dispx[4] = 0.0;   dispx[5] = disp;  dispx[6] = disp;  dispx[7] = 0.0;
        
        dispy[0] = 0.0;   dispy[1] = 0.0;   dispy[2] = lat_d; dispy[3] = lat_d;
        dispy[4] = 0.0;   dispy[5] = 0.0;   dispy[6] = lat_d; dispy[7] = lat_d;
        
        dispz[0] = 0.0;   dispz[1] = 0.0;   dispz[2] = 0.0;   dispz[3] = 0.0;
        dispz[4] = lat_d; dispz[5] = lat_d; dispz[6] = lat_d; dispz[7] = lat_d;
        
        // Zero gradient
        for (int n = 0; n < 8; ++n) { gx[n] = 0.0; gy[n] = 0.0; gz[n] = 0.0; }
        
        // Compute gradient using UNIQUE_HI (flexible) version with num_prony_terms=0 for pure hyperelastic
        // gamma=1.0 for pure hyperelastic (no viscoelastic scaling)
        // For pure HE: prev_u = u (no history effect)
        hex8_mooney_rivlin_visco_gradient_unique_hi(
            1,            // nelements
            1,            // stride
            8,            // nnodes
            elements,     // elements
            points,       // points
            EPDM_C10,     // C10
            EPDM_C01,     // C01
            EPDM_K,       // K
            num_prony_terms,  // num_prony_terms = 0 for pure hyperelastic
            nullptr,      // alpha (not needed for num_prony_terms=0)
            nullptr,      // beta (not needed for num_prony_terms=0)
            1.0,          // gamma = 1.0 for pure hyperelastic
            0,            // history_stride
            history,      // history (null)
            1,            // u_stride
            dispx, dispy, dispz,  // prev_u (same as u for pure HE)
            dispx, dispy, dispz,  // u (current displacement)
            1,            // out_stride
            gx, gy, gz    // output gradient
        );
        
        // Debug: print all nodal forces for first few steps
        if (i > 0 && i < 5) {
            printf("  Debug step %d: gx = [", i);
            for (int n = 0; n < 8; ++n) printf("%.4e ", gx[n]);
            printf("]\n");
        }
        
        // Reaction force at node 1 (one of the right face nodes)
        // Right face nodes: 1, 2, 5, 6 (x=1)
        // gradient = internal force pointing INTO the element
        // For tension, gradient on right face should be positive (resisting outward motion)
        double sfem_rf_node = gx[1];  // Single node reaction
        
        // Error computation
        double error = fabs(sfem_rf_node - marc_rf);
        double error_pct = (marc_rf != 0.0) ? 100.0 * error / fabs(marc_rf) : 0.0;
        
        if (fabs(marc_rf) > 1e-6) {
            if (error > max_error) max_error = error;
            sum_error += error_pct;
            count++;
        }
        
        // Print every 20 steps or first 20
        if (i < 20 || i % 20 == 0) {
            printf("%6.1f  %12.6e  %12.6e  %12.6e  %12.6e  %8.2f%%\n",
                   t, disp, marc_rf, sfem_rf_node, error, error_pct);
        }
    }
    
    printf("\n=======================================================\n");
    printf("Summary:\n");
    printf("  Max absolute error:  %.6e N\n", max_error);
    printf("  Mean relative error: %.2f%%\n", (count > 0) ? sum_error / count : 0.0);
    printf("=======================================================\n");
    
    double mean_error = (count > 0) ? sum_error / count : 0.0;
    if (mean_error < 5.0) {
        printf("\nPASS: Mean error < 5%%\n");
        return 0;
    } else {
        printf("\nFAIL: Mean error >= 5%%\n");
        return 1;
    }
}

